tosca_definitions_version: tosca_simple_yaml_1_0
metadata:
  template_name: vCPE_infra
  template_version: "1.0"
  template_author: onap
description: vCPE_infra

imports:
  - onap_dm.yaml

node_types:
  onap.vcpe_infra:
    derived_from: tosca.nodes.nfv.VNF
    properties:
      descriptor_id:
        type: string
        constraints: [ valid_values: [ b1bb0ce7-1111-4fa7-95ed-4840d70a1177 ] ]
        default: b1bb0ce7-1111-4fa7-95ed-4840d70a1177
      provider:
        type: string
        constraints: [ valid_values: [ onap ] ]
        default: onap
      product_name:
        type: string
        constraints: [ valid_values: [ vcpe_infra ] ]
        default: vcpe_infra
      software_version:
        type: string
        constraints: [ valid_values: [ '1.0' ] ]
        default: '1.0'
      descriptor_version:
        type: string
        constraints: [ valid_values: [ '1.0' ] ]
        default: '1.0'
      flavour_id:
        type: string
        constraints: [ valid_values: [ simple ] ]  #only one and only allowed one DF in this example
        default: simple
      flavour_description:
        type: string
        default: simple
      vnfm_info:
        type: list
        entry_schema:
          type: string
        default: ['gvnfm']

topology_template:
  substitution_mappings:
    node_type: onap.vcpe_infra
    requirements:
      - virtual_link: [ Cp_vaaa_public, virtual_link ] # expose as external CP
      - virtual_link: [ Cp_vaaa_onap_private, virtual_link ] # expose as external CP
      - virtual_link: [ Cp_vdns_public, virtual_link ]
      - virtual_link: [ Cp_vdns_onap_private, virtual_link ]
      - virtual_link: [ Cp_vdhcp_public, virtual_link ]
      - virtual_link: [ Cp_vdhcp_onap_private, virtual_link ]
      - virtual_link: [ Cp_vweb_public, virtual_link ]
      - virtual_link: [ Cp_vweb_onap_private, virtual_link ]

  inputs:
    vcpe_image_name:
      type: string
      description: image name for vcpe in openstack glance
      default: ubuntu_16.04
    #public_net_id:
    #  type: string
    #  description: public network id used during onap installation
    #onap_private_net_id:
    #  type: string
    #  description: onap OAM network id
    onap_private_net_cidr:
      type: string
      description: oanp OAM network cidr
      default: 10.0.0.0/16
    mr_ip_addr:
      type: string
      description: message router ip that for vDHCP configuration 
      default: 10.0.11.1
    dcae_collector_ip:
      type: string
      description: dcae collector ip
      default: 10.0.4.102
    dcae_collector_port:
      type: integer
      description: dcae collector port
      default: 8080
    repo_url_blob:
      type: string
      description: url of the repo hosting demo package 
      default: https://nexus.onap.org/content/sites/raw
    repo_url_artifacts:
      type: string
      description: url of the repo hosting demo package artifacts
      default: https://nexus.onap.org/content/groups/staging
    demo_artifacts_version:
      type: string
      description: artifacts version used in demo vnfs
      default: 1.2.0
    install_script_version:
      type: string
      description: install script version number
      default: 1.2.0-SNAPSHOT
    cloud_env:
      type: string
      description: cloud environment(openstack or rackspace)
      default: openstack
    pub_key:
      type: string
      description: ssh public key
      default: ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDGx6SKrAuCz1V8KGevZueksLdWoPWJP6z3r29Z7TmPVEOjM+7PIPeSs2BVRx3rnHZBAlasMrZ+fJBS25ts9vfC+ItezQah/hr9vrkmwxCR54Lb84poW+sToPeF6i5eZY7W+jWJfLaFSFx9d2vp4zes/fOlT3NvYCXbn/3QdryQoGl7VFI8oemZypVcikZXElJeeKgAVdSwnrzuqtO/tmbXcAeSbYvVjki8ywYcsWMVMYWUWhh+1BAB6kXnTsIWqzrq0Pfvy+81WDwtiqsqmd93HY8hE0scBrXFBZzQS/AYfIFBlEuFNdLczchntjbZ0n7dmDXk8zHtCZYNk7kwb8k/ lulianhao@llu-nuc1
    cpe_signal_net_id:
      type: string
      description: cpe signal net name
      default: zdfw1cpe01_private
    cpe_signal_net_cidr:
      type: string
      description: cpe signal net cidr
      default: 10.4.0.0/24
    cpe_public_net_id:
      type: string
      description: cpe public net name
      default: zdfw1cpe01_public
    cpe_public_net_cidr:
      type: string
      description: cpe public net cidr
      default: 10.2.0.0/24
    vdhcp_name_0:
      type: string
      description: vdu vdhcp_0 name
      default: zdcpe1cpe01dhcp01
    vdhcp_private_ip_0:
      type: string
      description: ip of vdhcp port to cpe signal net 
      default: 10.4.0.1
    vdhcp_private_ip_1:
      type: string
      description: ip of vdhcp port to onap oam net 
      default: 10.0.101.1
    vaaa_name_0:
      type: string
      description: vdu vaaa_0 name
      default: zdcpe1cpe01aaa01
    vaaa_private_ip_0:
      type: string
      description: ip of vaaa port to cpe signal net 
      default: 10.4.0.4
    vaaa_private_ip_1:
      type: string
      description: ip of vaaa port to onap oam net 
      default: 10.0.101.2
    vdns_name_0:
      type: string
      description: vdu vdns_0 name
      default: zdcpe1cpe01dns01
    vdns_private_ip_0:
      type: string
      description: ip of vdns port to cpe public net 
      default: 10.2.0.1
    vdns_private_ip_1:
      type: string
      description: ip of vdns port to onap oam net 
      default: 10.0.101.3
    vweb_name_0:
      type: string
      description: vdu vweb_0 name
      default: zdcpe1cpe01web01
    vweb_private_ip_0:
      type: string
      description: ip of vweb port to cpe public net 
      default: 10.2.0.10
    vweb_private_ip_1:
      type: string
      description: ip of vweb port to onap oam net 
      default: 10.0.101.40
    vnf_id:
      type: string
      description: The VNF ID is provided by ONAP
      default: vCPE_Infrastructure_demo_app
    vf_module_id:
      type: string
      description: The vCPE Module ID is provided by ONAP
      default: vCPE_Intrastructure
    
  node_templates:
    #onap public net
    #VL_public:
    #  type: tosca.nodes.nfv.VnfVirtualLink
    #  properties:
    #    connectivity_type:
    #      layer_protocol: ipv4
    #    vl_profile:
    #      max_bit_rate_requirements:
    #        root: 10000000
    #        leaf: 10000000
    #      min_bit_rate_requirements:
    #        root: 10000000
    #        leaf: 10000000
    #      networkName: { get_input: public_net_id }

    #onap oam net
    #VL_onap_private:
    #  type: tosca.nodes.nfv.VnfVirtualLink
    #  properties:
    #    connectivity_type:
    #      layer_protocol: ipv4
    #    vl_profile:
    #      max_bit_rate_requirements:
    #        root: 10000000
    #        leaf: 10000000
    #      min_bit_rate_requirements:
    #        root: 10000000
    #        leaf: 10000000
    #      networkName: { get_input: onap_private_net_id }
    #      cidr: { get_input: onap_private_net_cidr }

    #cpe signal network
    VL_cpe_signal:
      type: tosca.nodes.nfv.VnfVirtualLink
      properties:
        connectivity_type:
          layer_protocol: ipv4
        vl_profile:
          max_bit_rate_requirements:
            root: 10000000
            leaf: 10000000
          min_bit_rate_requirements:
            root: 10000000
            leaf: 10000000
          networkName: { get_input: cpe_signal_net_id}
          cidr: { get_input: cpe_signal_net_cidr }
          dhcpEnabled: false
 
    #cpe public network
    VL_cpe_public:
      type: tosca.nodes.nfv.VnfVirtualLink
      properties:
        connectivity_type:
          layer_protocol: ipv4
        vl_profile:
          max_bit_rate_requirements:
            root: 10000000
            leaf: 10000000
          min_bit_rate_requirements:
            root: 10000000
            leaf: 10000000
          networkName: { get_input: cpe_public_net_id}
          cidr: { get_input: cpe_public_net_cidr }
          dhcpEnabled: false

    # vaaa related
    Cp_vaaa_public:
      type: tosca.nodes.nfv.VduCp
      properties:
        layer_protocol: [ipv4]
        trunk_mode: false
        protocol_data:
          - asscociated_layer_protocol: ipv4
            address_data:
              address_type: ip_address
              l3_address_data:
                ip_address_assignment: false
                floating_ip_activated: false
      requirements:
        - virtual_binding: VDU_vaaa_0
        #- virtual_link: VL_public

    Cp_vaaa_onap_private:
      type: tosca.nodes.nfv.VduCp
      properties:
        layer_protocol: [ipv4]
        trunk_mode: false
        protocol_data:
          - asscociated_layer_protocol: ipv4
            address_data:
              address_type: ip_address
              l3_address_data:
                ip_address_assignment: false
                floating_ip_activated: false
                fixed_ip_address:
                  - { get_input: vaaa_private_ip_1 }
      requirements:
        - virtual_binding: VDU_vaaa_0
        #- virtual_link: VL_onap_private

    Cp_vaaa_cpe_signal:
      type: tosca.nodes.nfv.VduCp
      properties:
        layer_protocol: [ipv4]
        trunk_mode: false
        protocol_data:
          - asscociated_layer_protocol: ipv4
            address_data:
              address_type: ip_address
              l3_address_data:
                ip_address_assignment: false
                floating_ip_activated: false
                fixed_ip_address:
                  - { get_input: vaaa_private_ip_0 }
      requirements:
        - virtual_binding: VDU_vaaa_0
        - virtual_link: VL_cpe_signal

    VDU_vaaa_0:
      type: tosca.nodes.nfv.Vdu.Compute
      properties:
        name: { get_input: vaaa_name_0 }
        description: vaaa
        configurable_properties: 
          additional_vnfc_configurable_properties: {}
        vdu_profile:
          min_number_of_instances: 1
          max_number_of_instances: 1
          watchdog: none
        inject_files:
          - source_path: artifacts/keys/authorized_keys #SSH authorized_keys
            dest_path: /home/ubuntu/.ssh/authorized_keys
        #TODO metadata
        #metadata:
        #  vnf_id: { get_input: vnf_id }
        #  vf_module_id: { get_input: vf_module_id }
      capabilities:
        virtual_compute:
          properties:
            #TODO add local disk size
            virtual_memory:
              virtual_mem_size: 4096 MB
            virtual_cpu:
              num_virtual_cpu: 2              
      artifacts:
        sw_image: #TODO need to put glance image name here
          file: { get_input: vcpe_image_name }
      interfaces:
        Standard:
          configure:
            #TODO cloudinit
            implementation: ../artifacts/scripts/vaaa_config.sh
            inputs:
              __dcae_collector_ip__: { get_input: dcae_collector_ip } 
              __dcae_collector_port__: { get_input: dcae_collector_port }
              __cpe_signal_net_ipaddr__: { get_input: vaaa_private_ip_0 }
              __oam_ipaddr__: { get_input: vaaa_private_ip_1 }
              __oam_cidr__: { get_input: onap_private_net_cidr }
              __cpe_signal_net_cidr__: { get_input: cpe_signal_net_cidr }
              __repo_url_blob__ : { get_input: repo_url_blob }
              __repo_url_artifacts__ : { get_input: repo_url_artifacts }
              __demo_artifacts_version__ : { get_input: demo_artifacts_version }
              __install_script_version__ : { get_input: install_script_version }
              __cloud_env__ : { get_input: cloud_env }

    # vdns related
    Cp_vdns_public:
      type: tosca.nodes.nfv.VduCp
      properties:
        layer_protocol: [ipv4]
        trunk_mode: false
        protocol_data:
          - asscociated_layer_protocol: ipv4
            address_data:
              address_type: ip_address
              l3_address_data:
                ip_address_assignment: false
                floating_ip_activated: false
      requirements:
        - virtual_binding: VDU_vdns_0
        #- virtual_link: VL_public

    Cp_vdns_onap_private:
      type: tosca.nodes.nfv.VduCp
      properties:
        layer_protocol: [ipv4]
        trunk_mode: false
        protocol_data:
          - asscociated_layer_protocol: ipv4
            address_data:
              address_type: ip_address
              l3_address_data:
                ip_address_assignment: false
                floating_ip_activated: false
                fixed_ip_address:
                  - { get_input: vdns_private_ip_1 }
      requirements:
        - virtual_binding: VDU_vdns_0
        #- virtual_link: VL_onap_private

    Cp_vdns_cpe_public:
      type: tosca.nodes.nfv.VduCp
      properties:
        layer_protocol: [ipv4]
        trunk_mode: false
        protocol_data:
          - asscociated_layer_protocol: ipv4
            address_data:
              address_type: ip_address
              l3_address_data:
                ip_address_assignment: false
                floating_ip_activated: false
                fixed_ip_address:
                  - { get_input: vdns_private_ip_0 }
      requirements:
        - virtual_binding: VDU_vdns_0
        - virtual_link: VL_cpe_public

    VDU_vdns_0:
      type: tosca.nodes.nfv.Vdu.Compute
      properties:
        name: { get_input: vdns_name_0 }
        description: vdns
        configurable_properties: 
          additional_vnfc_configurable_properties: {}
        vdu_profile:
          min_number_of_instances: 1
          max_number_of_instances: 1
          watchdog: none
        inject_files:
          - source_path: artifacts/keys/authorized_keys #SSH authorized_keys
            dest_path: /home/ubuntu/.ssh/authorized_keys
        #TODO metadata
        #metadata:
        #  vnf_id: { get_input: vnf_id }
        #  vf_module_id: { get_input: vf_module_id }
      capabilities:
        virtual_compute:
          properties:
            #TODO add local disk size
            virtual_memory:
              virtual_mem_size: 4096 MB
            virtual_cpu:
              num_virtual_cpu: 2              
      artifacts:
        sw_image: #TODO need to put glance image name here
          file: { get_input: vcpe_image_name }
      interfaces:
        Standard:
          configure:
            #TODO cloudinit
            implementation: ../artifacts/scripts/vdns_config.sh
            inputs:
              __oam_ipaddr__ : { get_input: vdns_private_ip_1 }
              __cpe_public_net_ipaddr__: { get_input: vdns_private_ip_0 }
              __oam_cidr__: { get_input: onap_private_net_cidr }
              __cpe_public_net_cidr__: { get_input: cpe_public_net_cidr }
              __repo_url_blob__ : { get_input: repo_url_blob }
              __repo_url_artifacts__ : { get_input: repo_url_artifacts }
              __demo_artifacts_version__ : { get_input: demo_artifacts_version }
              __install_script_version__ : { get_input: install_script_version }
              __cloud_env__ : { get_input: cloud_env }

    # vdhcp related
    Cp_vdhcp_public:
      type: tosca.nodes.nfv.VduCp
      properties:
        layer_protocol: [ipv4]
        trunk_mode: false
        protocol_data:
          - asscociated_layer_protocol: ipv4
            address_data:
              address_type: ip_address
              l3_address_data:
                ip_address_assignment: false
                floating_ip_activated: false
      requirements:
        - virtual_binding: VDU_vdhcp_0
        #- virtual_link: VL_public

    Cp_vdhcp_onap_private:
      type: tosca.nodes.nfv.VduCp
      properties:
        layer_protocol: [ipv4]
        trunk_mode: false
        protocol_data:
          - asscociated_layer_protocol: ipv4
            address_data:
              address_type: ip_address
              l3_address_data:
                ip_address_assignment: false
                floating_ip_activated: false
                fixed_ip_address:
                  - { get_input: vdhcp_private_ip_1 }
      requirements:
        - virtual_binding: VDU_vdhcp_0
        #- virtual_link: VL_onap_private

    Cp_vdhcp_cpe_signal:
      type: tosca.nodes.nfv.VduCp
      properties:
        layer_protocol: [ipv4]
        trunk_mode: false
        protocol_data:
          - asscociated_layer_protocol: ipv4
            address_data:
              address_type: ip_address
              l3_address_data:
                ip_address_assignment: false
                floating_ip_activated: false
                fixed_ip_address:
                  - { get_input: vdhcp_private_ip_0 }
      requirements:
        - virtual_binding: VDU_vdhcp_0
        - virtual_link: VL_cpe_signal

    VDU_vdhcp_0:
      type: tosca.nodes.nfv.Vdu.Compute
      properties:
        name: { get_input: vdhcp_name_0 }
        description: vdhcp
        configurable_properties: 
          additional_vnfc_configurable_properties: {}
        vdu_profile:
          min_number_of_instances: 1
          max_number_of_instances: 1
          watchdog: none
        inject_files:
          - source_path: artifacts/keys/authorized_keys #SSH authorized_keys
            dest_path: /home/ubuntu/.ssh/authorized_keys
        #TODO metadata
        #metadata:
        #  vnf_id: { get_input: vnf_id }
        #  vf_module_id: { get_input: vf_module_id }
      capabilities:
        virtual_compute:
          properties:
            #TODO add local disk size
            virtual_memory:
              virtual_mem_size: 4096 MB
            virtual_cpu:
              num_virtual_cpu: 2              
      artifacts:
        sw_image: #TODO need to put glance image name here
          file: { get_input: vcpe_image_name }
      interfaces:
        Standard:
          configure:
            #TODO cloudinit
            implementation: ../artifacts/scripts/vdhcp_config.sh
            inputs:
              __oam_ipaddr__ : { get_param: vdhcp_private_ip_1 }
              __cpe_signal_ipaddr__ : { get_param: vdhcp_private_ip_0 }
              __oam_cidr__ : { get_param: onap_private_net_cidr }
              __cpe_signal_net_cidr__ : { get_param: cpe_signal_net_cidr }
              __mr_ip_addr__ : { get_param: mr_ip_addr }
              __repo_url_blob__ : { get_param: repo_url_blob }
              __repo_url_artifacts__ : { get_param: repo_url_artifacts }
              __demo_artifacts_version__ : { get_param: demo_artifacts_version }
              __install_script_version__ : { get_param: install_script_version }
              __cloud_env__ : { get_param: cloud_env }
    # vweb related
    Cp_vweb_public:
      type: tosca.nodes.nfv.VduCp
      properties:
        layer_protocol: [ipv4]
        trunk_mode: false
        protocol_data:
          - asscociated_layer_protocol: ipv4
            address_data:
              address_type: ip_address
              l3_address_data:
                ip_address_assignment: false
                floating_ip_activated: false
      requirements:
        - virtual_binding: VDU_vweb_0
        #- virtual_link: VL_public

    Cp_vweb_onap_private:
      type: tosca.nodes.nfv.VduCp
      properties:
        layer_protocol: [ipv4]
        trunk_mode: false
        protocol_data:
          - asscociated_layer_protocol: ipv4
            address_data:
              address_type: ip_address
              l3_address_data:
                ip_address_assignment: false
                floating_ip_activated: false
                fixed_ip_address:
                  - { get_input: vweb_private_ip_1 }
      requirements:
        - virtual_binding: VDU_vweb_0
        #- virtual_link: VL_onap_private

    Cp_vweb_cpe_public:
      type: tosca.nodes.nfv.VduCp
      properties:
        layer_protocol: [ipv4]
        trunk_mode: false
        protocol_data:
          - asscociated_layer_protocol: ipv4
            address_data:
              address_type: ip_address
              l3_address_data:
                ip_address_assignment: false
                floating_ip_activated: false
                fixed_ip_address:
                  - { get_input: vweb_private_ip_0 }
      requirements:
        - virtual_binding: VDU_vweb_0
        - virtual_link: VL_cpe_public

    VDU_vweb_0:
      type: tosca.nodes.nfv.Vdu.Compute
      properties:
        name: { get_input: vweb_name_0 }
        description: vweb
        configurable_properties: 
          additional_vnfc_configurable_properties: {}
        vdu_profile:
          min_number_of_instances: 1
          max_number_of_instances: 1
          watchdog: none
        inject_files:
          - source_path: artifacts/keys/authorized_keys #SSH authorized_keys
            dest_path: /home/ubuntu/.ssh/authorized_keys
        #TODO metadata
        #metadata:
        #  vnf_id: { get_input: vnf_id }
        #  vf_module_id: { get_input: vf_module_id }
      capabilities:
        virtual_compute:
          properties:
            #TODO add local disk size
            virtual_memory:
              virtual_mem_size: 4096 MB
            virtual_cpu:
              num_virtual_cpu: 2              
      artifacts:
        sw_image: #TODO need to put glance image name here
          file: { get_input: vcpe_image_name }
      interfaces:
        Standard:
          configure:
            #TODO cloudinit
            implementation: ../artifacts/scripts/vweb_config.sh
            inputs:
              __oam_ipaddr__ : { get_param: vweb_private_ip_1 }
              __cpe_public_ipaddr__: { get_param: vweb_private_ip_0 }
              __oam_cidr__: { get_param: onap_private_net_cidr }
              __cpe_public_net_cidr__: { get_param: cpe_public_net_cidr }
              __repo_url_blob__ : { get_param: repo_url_blob }
              __repo_url_artifacts__ : { get_param: repo_url_artifacts }
              __demo_artifacts_version__ : { get_param: demo_artifacts_version }
              __install_script_version__ : { get_param: install_script_version }
              __cloud_env__ : { get_param: cloud_env }